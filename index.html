<script>
  const EDGE_FUNCTION_URL = "https://mvmvqycvorstsftcldzs.supabase.co/functions/v1/oauth-authorize";
  const SUPABASE_URL = "https://mvmvqycvorstsftcldzs.supabase.co";
  const GOOGLE_START_URL = `${SUPABASE_URL}/functions/v1/oauth-google-start`;

  // IMPORTANT: must match the exact GitHub page URL that Alexa opens
  const LOGIN_PAGE_URL = "https://amirezz87.github.io/doc/";

  const params = new URLSearchParams(window.location.search);
  const state = params.get("state");
  const clientId = params.get("client_id");
  const redirectUri = params.get("redirect_uri");

  const form = document.getElementById("loginForm");
  const errorDiv = document.getElementById("error");
  const loadingDiv = document.getElementById("loading");
  const submitBtn = document.getElementById("submitBtn");
  const googleBtn = document.getElementById("googleBtn");

  function showError(msg) {
    errorDiv.textContent = msg;
    errorDiv.classList.add("show");
  }

  function hideError() {
    errorDiv.classList.remove("show");
  }

  function setLoading(isLoading) {
    if (isLoading) {
      form.style.display = "none";
      loadingDiv.classList.add("show");
      submitBtn.disabled = true;
      if (googleBtn) googleBtn.disabled = true;
    } else {
      form.style.display = "block";
      loadingDiv.classList.remove("show");
      submitBtn.disabled = false;
      if (googleBtn) googleBtn.disabled = false;
    }
  }

  // Google login click â†’ redirects to oauth-google-start
  if (googleBtn) {
    googleBtn.addEventListener("click", () => {
      hideError();

      if (!state || !clientId || !redirectUri) {
        showError("Invalid OAuth request. Please start linking from the Alexa app.");
        return;
      }

      const u = new URL(GOOGLE_START_URL);
      u.searchParams.set("state", state);
      u.searchParams.set("client_id", clientId);
      u.searchParams.set("redirect_uri", redirectUri);

      // where Google should return (Edge Function callback, NOT the login page)
      // oauth-google-start will append &login_page=... to remember where it started from if you want
      u.searchParams.set("login_page", LOGIN_PAGE_URL);

      window.location.href = u.toString();
    });
  }

  // Email/password login (existing)
  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    hideError();

    if (!state || !clientId || !redirectUri) {
      showError("Invalid OAuth request. Please start linking from the Alexa app.");
      return;
    }

    setLoading(true);

    try {
      const res = await fetch(EDGE_FUNCTION_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          email: email.value,
          password: password.value,
          state,
          client_id: clientId,
          redirect_uri: redirectUri
        })
      });

      const data = await res.json();

      if (res.ok && data.redirect_url) {
        window.location.href = data.redirect_url;
      } else {
        throw new Error(data.error || "Authentication failed");
      }
    } catch (err) {
      setLoading(false);
      showError("Failed to connect to authentication server.");
    }
  });

  // Guard
  if (!state || !clientId || !redirectUri) {
    showError("Invalid OAuth request. Please start linking from the Alexa app.");
    submitBtn.disabled = true;
    if (googleBtn) googleBtn.disabled = true;
  }
</script>
