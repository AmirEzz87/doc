<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Link Your Smart Home with Alexa</title>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #0f5fa8 0%, #4bb3e6 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .container {
      background: #ffffff;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.25);
      max-width: 400px;
      width: 100%;
      padding: 40px;
    }

    .brand {
      text-align: center;
      margin-bottom: 25px;
    }

    .brand img {
      width: 160px;
      max-width: 70%;
      height: auto;
      display: inline-block;
      user-select: none;
      -webkit-user-drag: none;
    }

    h1 {
      color: #222;
      font-size: 22px;
      margin-bottom: 10px;
      text-align: center;
    }

    p {
      color: #555;
      text-align: center;
      margin-bottom: 18px;
      font-size: 14px;
    }

    .debug {
      display: none;
      background: #eef7ff;
      border: 1px solid #d6ecff;
      color: #0f5fa8;
      padding: 10px 12px;
      border-radius: 10px;
      margin: 0 0 16px;
      font-size: 12px;
      line-height: 1.35;
      text-align: center;
      white-space: pre-wrap;
    }

    .input-group { margin-bottom: 20px; }

    label {
      display: block;
      color: #333;
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 8px;
    }

    input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 15px;
      transition: border-color 0.3s;
    }

    input:focus {
      outline: none;
      border-color: #0f5fa8;
    }

    button.primary-btn {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #0f5fa8 0%, #4bb3e6 100%);
      color: #fff;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    button.primary-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(15, 95, 168, 0.4);
    }

    button.primary-btn:active { transform: translateY(0); }

    button.primary-btn:disabled,
    button.google-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .google-btn {
      width: 100%;
      padding: 14px;
      background: #ffffff;
      color: #222;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
      margin-bottom: 14px;
    }

    .google-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(0,0,0,0.08);
      border-color: #cfcfcf;
    }

    .google-btn:active { transform: translateY(0); }

    .google-icon {
      width: 18px;
      height: 18px;
      display: inline-block;
    }

    .divider {
      display: flex;
      align-items: center;
      gap: 12px;
      margin: 8px 0 18px;
      color: #777;
      font-size: 12px;
      user-select: none;
    }

    .divider::before,
    .divider::after {
      content: "";
      flex: 1;
      height: 1px;
      background: #e9e9e9;
    }

    .error {
      background: #fdeaea;
      color: #b00020;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 16px;
      font-size: 14px;
      display: none;
      text-align: center;
    }

    .error.show { display: block; }

    .loading {
      display: none;
      text-align: center;
      margin-top: 18px;
    }

    .loading.show { display: block; }

    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #0f5fa8;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="brand">
      <img src="hbot-logo.png" alt="HBOT Logo" />
    </div>

    <h1>Link Your Smart Home</h1>
    <p>Sign in to connect your HBOT account with Alexa</p>

    <div id="debug" class="debug"></div>
    <div id="error" class="error"></div>

    <form id="loginForm">
      <button type="button" id="googleBtn" class="google-btn">
        <svg class="google-icon" viewBox="0 0 48 48" aria-hidden="true">
          <path fill="#EA4335" d="M24 9.5c3.5 0 6.6 1.2 9 3.6l6.7-6.7C35.6 2.4 30.2 0 24 0 14.6 0 6.5 5.4 2.6 13.3l7.8 6.1C12.3 13.5 17.7 9.5 24 9.5z"/>
          <path fill="#4285F4" d="M46.1 24.6c0-1.6-.1-2.8-.4-4.1H24v7.8h12.6c-.3 2-1.7 5-4.9 7l7.6 5.9c4.4-4 6.8-10 6.8-16.6z"/>
          <path fill="#FBBC05" d="M10.4 28.6c-.5-1.4-.8-2.9-.8-4.6s.3-3.2.8-4.6l-7.8-6.1C.9 16.7 0 20.2 0 24c0 3.8.9 7.3 2.6 10.7l7.8-6.1z"/>
          <path fill="#34A853" d="M24 48c6.2 0 11.4-2 15.2-5.5l-7.6-5.9c-2 1.4-4.7 2.4-7.6 2.4-6.3 0-11.7-4-13.6-9.9l-7.8 6.1C6.5 42.6 14.6 48 24 48z"/>
        </svg>
        Continue with Google
      </button>

      <div class="divider">or</div>

      <div class="input-group">
        <label for="email">Email</label>
        <input type="email" id="email" required placeholder="you@email.com" autocomplete="email" />
      </div>

      <div class="input-group">
        <label for="password">Password</label>
        <input type="password" id="password" required placeholder="••••••••" autocomplete="current-password" />
      </div>

      <button type="submit" id="submitBtn" class="primary-btn">Sign In &amp; Link Account</button>
    </form>

    <div id="loading" class="loading">
      <div class="spinner"></div>
      <p style="margin-top: 10px; color: #555;">Authenticating…</p>
    </div>
  </div>

  <script>
    // ====== CONFIG ======
    const SUPABASE_URL = 'https://mvmvqycvorstsftcldzs.supabase.co';

    // Existing email/pass authorize (your working one)
    const EDGE_FUNCTION_URL = `${SUPABASE_URL}/functions/v1/oauth-authorize`;

    // Starts Google flow (redirects to Google)
    const GOOGLE_START_URL = `${SUPABASE_URL}/functions/v1/oauth-google-start`;

    // Finishes Google flow (creates Alexa auth code + redirects to Alexa)
    // You said you created: oauth-authorize-google
    const GOOGLE_AUTHORIZE_URL = `${SUPABASE_URL}/functions/v1/oauth-authorize-google`;

    // Where this login page lives (must match your GitHub Pages)
    const LOGIN_PAGE_URL = 'https://amirezz87.github.io/doc/';

    // Storage key to preserve Alexa params across Google redirects
    const CTX_KEY = 'alexa_oauth_ctx_v1';

    // ====== ELEMENTS ======
    const form = document.getElementById('loginForm');
    const errorDiv = document.getElementById('error');
    const loadingDiv = document.getElementById('loading');
    const submitBtn = document.getElementById('submitBtn');
    const googleBtn = document.getElementById('googleBtn');
    const debugDiv = document.getElementById('debug');

    // ====== HELPERS ======
    function showError(msg) {
      errorDiv.textContent = msg;
      errorDiv.classList.add('show');
    }
    function hideError() {
      errorDiv.classList.remove('show');
    }
    function setLoading(isLoading) {
      if (isLoading) {
        loadingDiv.classList.add('show');
        submitBtn.disabled = true;
        googleBtn.disabled = true;
      } else {
        loadingDiv.classList.remove('show');
        submitBtn.disabled = false;
        googleBtn.disabled = false;
      }
    }
    function setDebug(text) {
      // set to 'block' if you want to see debug on phone
      // debugDiv.style.display = 'block';
      debugDiv.textContent = text;
    }

    function getParamsFromUrlOrStorage() {
      const params = new URLSearchParams(window.location.search);
      let state = params.get('state');
      let clientId = params.get('client_id');
      let redirectUri = params.get('redirect_uri');

      // If missing (happens after Google redirect), restore from sessionStorage
      if (!state || !clientId || !redirectUri) {
        try {
          const saved = JSON.parse(sessionStorage.getItem(CTX_KEY) || 'null');
          if (saved) {
            state = state || saved.state;
            clientId = clientId || saved.clientId;
            redirectUri = redirectUri || saved.redirectUri;
          }
        } catch (_) {}
      }

      // If we have them now, keep them stored for any future redirects
      if (state && clientId && redirectUri) {
        sessionStorage.setItem(CTX_KEY, JSON.stringify({ state, clientId, redirectUri }));
      }

      return { state, clientId, redirectUri };
    }

    function getGoogleReturnPayload() {
      // Supabase can return either:
      // - query param: ?code=...
      // - hash fragment: #access_token=...&refresh_token=...
      const qs = new URLSearchParams(window.location.search);
      const code = qs.get('code');

      const hash = (window.location.hash || '').replace(/^#/, '');
      const hs = new URLSearchParams(hash);
      const access_token = hs.get('access_token');
      const refresh_token = hs.get('refresh_token');

      return { code, access_token, refresh_token };
    }

    async function finalizeGoogleIfReturned() {
      const { state, clientId, redirectUri } = getParamsFromUrlOrStorage();
      const { code, access_token, refresh_token } = getGoogleReturnPayload();

      // Not a Google return → do nothing
      if (!code && !access_token) return;

      if (!state || !clientId || !redirectUri) {
        showError('Invalid OAuth request. Please start linking from the Alexa app.');
        return;
      }

      setLoading(true);
      hideError();

      try {
        const res = await fetch(GOOGLE_AUTHORIZE_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            state,
            client_id: clientId,
            redirect_uri: redirectUri,

            // one of these will exist depending on your Supabase config
            code,
            access_token,
            refresh_token
          })
        });

        const data = await res.json();

        // Expected response: { redirect_url: "https://pitangui.amazon.com/spa/skill/account-linking-status.html?...&code=...&state=..." }
        if (res.ok && data.redirect_url) {
          window.location.replace(data.redirect_url);
          return;
        }

        throw new Error(data.error || 'Google login failed');
      } catch (e) {
        setLoading(false);
        showError('Google login failed: ' + (e.message || 'Unknown error'));
      }
    }

    // ====== MAIN ======
    const ctx = getParamsFromUrlOrStorage();
    setDebug(
      `state: ${!!ctx.state}\nclient_id: ${!!ctx.clientId}\nredirect_uri: ${!!ctx.redirectUri}`
    );

    // If we landed here after Google, finish the linking automatically
    finalizeGoogleIfReturned();

    // ====== BUTTON ACTIONS ======

    // Google button → go to start function
    googleBtn.addEventListener('click', () => {
      hideError();
      const { state, clientId, redirectUri } = getParamsFromUrlOrStorage();

      if (!state || !clientId || !redirectUri) {
        showError('Invalid OAuth request. Please start linking from the Alexa app.');
        return;
      }

      // Your oauth-google-start should redirect to Supabase/Google,
      // and MUST set redirectTo back to LOGIN_PAGE_URL (this page).
      const u = new URL(GOOGLE_START_URL);
      u.searchParams.set('state', state);
      u.searchParams.set('client_id', clientId);
      u.searchParams.set('redirect_uri', redirectUri);
      u.searchParams.set('login_page', LOGIN_PAGE_URL); // IMPORTANT for correct return

      window.location.href = u.toString();
    });

    // Email/password submit
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      hideError();

      const { state, clientId, redirectUri } = getParamsFromUrlOrStorage();
      if (!state || !clientId || !redirectUri) {
        showError('Invalid OAuth request. Please start linking from the Alexa app.');
        return;
      }

      setLoading(true);

      try {
        const res = await fetch(EDGE_FUNCTION_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email: document.getElementById('email').value,
            password: document.getElementById('password').value,
            state,
            client_id: clientId,
            redirect_uri: redirectUri
          })
        });

        const data = await res.json();

        if (res.ok && data.redirect_url) {
          window.location.replace(data.redirect_url);
          return;
        }

        throw new Error(data.error || 'Authentication failed');
      } catch (err) {
        setLoading(false);
        showError('Failed to connect to authentication server.');
      }
    });
  </script>
</body>
</html>
