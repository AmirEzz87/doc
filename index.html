<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  const EDGE_FUNCTION_URL = "https://mvmvqycvorstsftcldzs.supabase.co/functions/v1/oauth-authorize";
  const SUPABASE_URL = "https://mvmvqycvorstsftcldzs.supabase.co";

  // ✅ PUT YOUR ANON KEY HERE
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im12bXZxeWN2b3JzdHNmdGNsZHpzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUwMDczNTQsImV4cCI6MjA3MDU4MzM1NH0.gA744wsXronSyRXHCS60DVcVqJ3_y0MgkqEhLsFxYDI";

  const AUTHORIZE_GOOGLE_URL = `${SUPABASE_URL}/functions/v1/oauth-authorize-google`;
  const GOOGLE_START_URL = `${SUPABASE_URL}/functions/v1/oauth-google-start`;

  const LOGIN_PAGE_URL = "https://amirezz87.github.io/doc/";

  const params = new URLSearchParams(window.location.search);

  // Alexa params (present when Alexa opens login page)
  let alexaState = params.get("state");
  let clientId = params.get("client_id");
  let redirectUri = params.get("redirect_uri");

  // Supabase callback param (present after Google login)
  const supabaseCode = params.get("code");

  const form = document.getElementById("loginForm");
  const errorDiv = document.getElementById("error");
  const loadingDiv = document.getElementById("loading");
  const submitBtn = document.getElementById("submitBtn");
  const googleBtn = document.getElementById("googleBtn");

  function showError(msg) {
    errorDiv.textContent = msg;
    errorDiv.classList.add("show");
  }

  function hideError() {
    errorDiv.classList.remove("show");
  }

  function setLoading(isLoading) {
    if (isLoading) {
      form.style.display = "none";
      loadingDiv.classList.add("show");
      submitBtn.disabled = true;
      googleBtn.disabled = true;
    } else {
      form.style.display = "block";
      loadingDiv.classList.remove("show");
      submitBtn.disabled = false;
      googleBtn.disabled = false;
    }
  }

  // --- Supabase client (for Google callback exchange) ---
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // ✅ If we came back from Google, finish the flow automatically
  async function handleGoogleCallbackIfNeeded() {
    if (!supabaseCode) return;

    // We’re in Google return step; Alexa params might be missing because Supabase doesn't keep them.
    // We stored them inside "state" (packed) in oauth-google-start, so we must unpack them.
    // Your oauth-google-start packed JSON into state using btoa(). So decode it here.
    try {
      setLoading(true);

      const packedState = params.get("state");
      if (!packedState) throw new Error("Missing packed state");

      const decoded = JSON.parse(atob(packedState));
      alexaState = decoded.alexa_state;
      clientId = decoded.client_id;
      redirectUri = decoded.redirect_uri;

      if (!alexaState || !clientId || !redirectUri) {
        throw new Error("Missing Alexa params after Google callback");
      }

      // Exchange Google code for Supabase session
      const { data, error } = await supabase.auth.exchangeCodeForSession(supabaseCode);
      if (error) throw error;

      const accessToken = data?.session?.access_token;
      if (!accessToken) throw new Error("Missing Supabase access token");

      // Call oauth-authorize-google to create Alexa auth code
      const res = await fetch(AUTHORIZE_GOOGLE_URL, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${accessToken}`,
        },
        body: JSON.stringify({
          state: alexaState,
          client_id: clientId,
          redirect_uri: redirectUri,
        }),
      });

      const out = await res.json();
      if (!res.ok || !out.redirect_url) {
        throw new Error(out.error || "Failed to authorize with Google");
      }

      window.location.href = out.redirect_url;
    } catch (e) {
      console.error(e);
      setLoading(false);
      showError("Google login failed. Please try again from Alexa app.");
    }
  }

  // Google login button → start flow (goes to oauth-google-start)
  googleBtn.addEventListener("click", () => {
    hideError();

    if (!alexaState || !clientId || !redirectUri) {
      showError("Invalid OAuth request. Please start linking from the Alexa app.");
      return;
    }

    const u = new URL(GOOGLE_START_URL);
    u.searchParams.set("state", alexaState);
    u.searchParams.set("client_id", clientId);
    u.searchParams.set("redirect_uri", redirectUri);
    u.searchParams.set("login_page", LOGIN_PAGE_URL);

    window.location.href = u.toString();
  });

  // Email/password login (your existing flow)
  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    hideError();

    if (!alexaState || !clientId || !redirectUri) {
      showError("Invalid OAuth request. Please start linking from the Alexa app.");
      return;
    }

    setLoading(true);

    try {
      const res = await fetch(EDGE_FUNCTION_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          email: email.value,
          password: password.value,
          state: alexaState,
          client_id: clientId,
          redirect_uri: redirectUri,
        }),
      });

      const data = await res.json();
      if (res.ok && data.redirect_url) {
        window.location.href = data.redirect_url;
      } else {
        throw new Error(data.error || "Authentication failed");
      }
    } catch (err) {
      setLoading(false);
      showError("Failed to connect to authentication server.");
    }
  });

  // Run callback handler first (this prevents your “invalid oauth request” after Google)
  handleGoogleCallbackIfNeeded();

  // If no params and no Google code → show error
  if (!supabaseCode && (!alexaState || !clientId || !redirectUri)) {
    showError("Invalid OAuth request. Please start linking from the Alexa app.");
    submitBtn.disabled = true;
    googleBtn.disabled = true;
  }
</script>
