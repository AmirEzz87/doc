<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Link Your Smart Home with Alexa</title>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #0f5fa8 0%, #4bb3e6 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .container {
      background: #ffffff;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.25);
      max-width: 400px;
      width: 100%;
      padding: 40px;
    }

    .brand { text-align: center; margin-bottom: 25px; }
    .brand img {
      width: 160px;
      max-width: 70%;
      height: auto;
      display: inline-block;
      user-select: none;
      -webkit-user-drag: none;
    }

    h1 { color: #222; font-size: 22px; margin-bottom: 10px; text-align: center; }
    p  { color: #555; text-align: center; margin-bottom: 24px; font-size: 14px; }

    .input-group { margin-bottom: 18px; }

    label {
      display: block;
      color: #333;
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 8px;
    }

    input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 15px;
      transition: border-color 0.3s;
    }
    input:focus { outline: none; border-color: #0f5fa8; }

    button.primary-btn {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #0f5fa8 0%, #4bb3e6 100%);
      color: #fff;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    button.primary-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(15, 95, 168, 0.4);
    }
    button.primary-btn:active { transform: translateY(0); }

    .google-btn {
      width: 100%;
      padding: 14px;
      background: #ffffff;
      color: #222;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
      margin-bottom: 14px;
    }
    .google-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(0,0,0,0.08);
      border-color: #cfcfcf;
    }
    .google-btn:active { transform: translateY(0); }

    .google-icon { width: 18px; height: 18px; display: inline-block; }

    .divider {
      display: flex;
      align-items: center;
      gap: 12px;
      margin: 8px 0 18px;
      color: #777;
      font-size: 12px;
      user-select: none;
    }
    .divider::before, .divider::after {
      content: "";
      flex: 1;
      height: 1px;
      background: #e9e9e9;
    }

    .error {
      background: #fdeaea;
      color: #b00020;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 16px;
      font-size: 14px;
      display: none;
      text-align: center;
      word-break: break-word;
    }
    .error.show { display: block; }

    .loading {
      display: none;
      text-align: center;
      margin-top: 18px;
    }
    .loading.show { display: block; }

    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #0f5fa8;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* Optional small debug box (hidden by default) */
    .debug {
      display: none;
      font-size: 12px;
      background: #f6f6f6;
      border: 1px solid #ddd;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 12px;
      white-space: pre-wrap;
      word-break: break-word;
      color: #333;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="brand">
      <img id="logo" src="hbot-logo.png" alt="HBOT Logo" />
    </div>

    <h1>Link Your Smart Home</h1>
    <p>Sign in to connect your HBOT account with Alexa</p>

    <div id="debug" class="debug"></div>
    <div id="error" class="error"></div>

    <form id="loginForm">
      <button type="button" id="googleBtn" class="google-btn">
        <svg class="google-icon" viewBox="0 0 48 48" aria-hidden="true">
          <path fill="#EA4335" d="M24 9.5c3.5 0 6.6 1.2 9 3.6l6.7-6.7C35.6 2.4 30.2 0 24 0 14.6 0 6.5 5.4 2.6 13.3l7.8 6.1C12.3 13.5 17.7 9.5 24 9.5z"/>
          <path fill="#4285F4" d="M46.1 24.6c0-1.6-.1-2.8-.4-4.1H24v7.8h12.6c-.3 2-1.7 5-4.9 7l7.6 5.9c4.4-4 6.8-10 6.8-16.6z"/>
          <path fill="#FBBC05" d="M10.4 28.6c-.5-1.4-.8-2.9-.8-4.6s.3-3.2.8-4.6l-7.8-6.1C.9 16.7 0 20.2 0 24c0 3.8.9 7.3 2.6 10.7l7.8-6.1z"/>
          <path fill="#34A853" d="M24 48c6.2 0 11.4-2 15.2-5.5l-7.6-5.9c-2 1.4-4.7 2.4-7.6 2.4-6.3 0-11.7-4-13.6-9.9l-7.8 6.1C6.5 42.6 14.6 48 24 48z"/>
        </svg>
        Continue with Google
      </button>

      <div class="divider">or</div>

      <div class="input-group">
        <label for="email">Email</label>
        <input type="email" id="email" required placeholder="you@email.com" autocomplete="email" />
      </div>

      <div class="input-group">
        <label for="password">Password</label>
        <input type="password" id="password" required placeholder="••••••••" autocomplete="current-password" />
      </div>

      <button type="submit" id="submitBtn" class="primary-btn">Sign In &amp; Link Account</button>
    </form>

    <div id="loading" class="loading">
      <div class="spinner"></div>
      <p style="margin-top: 10px; color: #555;">Loading…</p>
    </div>
  </div>

  <!-- Supabase JS CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
  // =======================
  // CHANGE THESE ONLY
  // =======================
  const SUPABASE_URL = 'https://mvmvqycvorstsftcldzs.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im12bXZxeWN2b3JzdHNmdGNsZHpzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUwMDczNTQsImV4cCI6MjA3MDU4MzM1NH0.gA744wsXronSyRXHCS60DVcVqJ3_y0MgkqEhLsFxYDI';
  // Optional:
  const LOGO_URL = 'hbot-logo.png';
  // =======================

  // Existing endpoints (email/password + google finish)
  const EDGE_FUNCTION_URL = `${SUPABASE_URL}/functions/v1/oauth-authorize`;
  const GOOGLE_AUTHORIZE_URL = `${SUPABASE_URL}/functions/v1/oauth-authorize-google`;

  // New endpoints (server-side session approach)
  const CREATE_SESSION_URL = `${SUPABASE_URL}/functions/v1/oauth-login-session-create`;
  const GET_SESSION_URL = `${SUPABASE_URL}/functions/v1/oauth-login-session-get`;
  const GOOGLE_START_URL = `${SUPABASE_URL}/functions/v1/oauth-google-start`;

  // Supabase client used ONLY to exchange ?code=... into a session
  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    auth: {
      persistSession: false,
      autoRefreshToken: false,
      detectSessionInUrl: false,
    },
  });

  // ====== UI ======
  const form = document.getElementById('loginForm');
  const errorDiv = document.getElementById('error');
  const loadingDiv = document.getElementById('loading');
  const submitBtn = document.getElementById('submitBtn');
  const googleBtn = document.getElementById('googleBtn');
  const debugDiv = document.getElementById('debug');

  // Set logo
  const logo = document.getElementById('logo');
  if (logo && LOGO_URL) logo.src = LOGO_URL;

  function showError(msg) {
    errorDiv.textContent = msg;
    errorDiv.classList.add('show');
  }
  function hideError() {
    errorDiv.classList.remove('show');
    errorDiv.textContent = '';
  }
  function setLoading(isLoading, label = 'Loading…') {
    const p = loadingDiv.querySelector('p');
    if (p) p.textContent = label;

    if (isLoading) {
      loadingDiv.classList.add('show');
      submitBtn.disabled = true;
      googleBtn.disabled = true;
    } else {
      loadingDiv.classList.remove('show');
      submitBtn.disabled = false;
      googleBtn.disabled = false;
    }
  }

  // ====== HELPERS ======
  function parseHashParams() {
    const hash = window.location.hash || '';
    if (!hash.startsWith('#')) return {};
    const s = hash.substring(1);
    const out = {};
    for (const part of s.split('&')) {
      const [k, v] = part.split('=');
      if (!k) continue;
      out[decodeURIComponent(k)] = decodeURIComponent(v || '');
    }
    return out;
  }

  function showDebugBox(text) {
    if (!debugDiv) return;
    debugDiv.style.display = 'block';
    debugDiv.textContent = text;
  }

  function getAlexaParamsFromQuery() {
    const q = new URLSearchParams(window.location.search);
    const state = q.get('state');
    const client_id = q.get('client_id');
    const redirect_uri = q.get('redirect_uri');

    if (state && client_id && redirect_uri) {
      return { alexa_state: state, client_id, redirect_uri };
    }
    return null;
  }

  async function loadAlexaParamsFromSessionId(sessionId) {
    const res = await fetch(`${GET_SESSION_URL}?session_id=${encodeURIComponent(sessionId)}`, {
      method: 'GET'
    });
    const data = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(data.error || 'Failed to load Alexa session');
    if (!data.alexa_state || !data.client_id || !data.redirect_uri) {
      throw new Error('Session is missing Alexa params');
    }
    return { alexa_state: data.alexa_state, client_id: data.client_id, redirect_uri: data.redirect_uri };
  }

  function buildDebugText() {
    const q = new URLSearchParams(window.location.search);
    const h = parseHashParams();
    return (
      "FULL URL:\n" + window.location.href + "\n\n" +
      "QUERY state=" + (q.get('state') || '') + "\n" +
      "QUERY client_id=" + (q.get('client_id') || '') + "\n" +
      "QUERY redirect_uri=" + (q.get('redirect_uri') || '') + "\n" +
      "QUERY code=" + (q.get('code') || '') + "\n\n" +
      "HASH access_token=" + (h['access_token'] || '') + "\n"
    );
  }

  // Show debug (keep it ON while testing; hide later)
  showDebugBox(buildDebugText());

  // ====== GOOGLE RETURN HANDLER ======
  (async function handleGoogleReturn() {
    const q = new URLSearchParams(window.location.search);
    const hash = parseHashParams();

    // Supabase may send errors in query
    const err = q.get('error') || hash['error'];
    const errDesc = q.get('error_description') || hash['error_description'];
    if (err) {
      showError(`Google sign-in failed: ${errDesc || err}`);
      return;
    }

    // If Supabase returned ?code=... (PKCE), exchange it
    const code = q.get('code');
    if (!code) return; // not returning from google

    setLoading(true, 'Completing Google sign-in…');
    hideError();

    let accessToken = null;
    try {
      const { data, error } = await sb.auth.exchangeCodeForSession(code);
      if (error) throw error;
      accessToken = data?.session?.access_token;
      if (!accessToken) throw new Error('No access token returned from Supabase session');
    } catch (e) {
      setLoading(false);
      showError(`Google sign-in exchange failed: ${e?.message || e}`);
      return;
    }

    // Now "state" query is our session_id
    const sessionId = q.get('state');
    if (!sessionId) {
      setLoading(false);
      showError('Missing session_id (state) after Google sign-in.');
      return;
    }

    let alexaParams;
    try {
      alexaParams = await loadAlexaParamsFromSessionId(sessionId);
    } catch (e) {
      setLoading(false);
      showError(e?.message || String(e));
      return;
    }

    // Call your existing edge function to create Alexa auth code
    setLoading(true, 'Finishing Google link…');
    try {
      const res = await fetch(GOOGLE_AUTHORIZE_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${accessToken}`,
        },
        body: JSON.stringify({
          state: alexaParams.alexa_state,
          client_id: alexaParams.client_id,
          redirect_uri: alexaParams.redirect_uri
        })
      });

      const data = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(data.error || `Google authorize failed (${res.status})`);
      if (!data.redirect_url) throw new Error('Missing redirect_url from oauth-authorize-google');

      // Redirect back to Alexa
      window.location.href = data.redirect_url;
    } catch (e) {
      setLoading(false);
      showError(e?.message || String(e));
    }
  })();

  // ====== GOOGLE BUTTON CLICK ======
  googleBtn.addEventListener('click', async () => {
    hideError();

    // Must be opened from Alexa with proper query params
    const alexaNow = getAlexaParamsFromQuery();
    if (!alexaNow) {
      showError('Invalid OAuth request. Please start linking from the Alexa app.');
      return;
    }

    setLoading(true, 'Starting Google sign-in…');

    try {
      // Create server-side session to preserve Alexa params
      const res = await fetch(CREATE_SESSION_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          alexa_state: alexaNow.alexa_state,
          client_id: alexaNow.client_id,
          redirect_uri: alexaNow.redirect_uri
        })
      });

      const data = await res.json().catch(() => ({}));
      if (!res.ok || !data.session_id) {
        throw new Error(data.error || 'Failed to create login session');
      }

      // Redirect to oauth-google-start with session_id (NOT Alexa state)
      const u = new URL(GOOGLE_START_URL);
      u.searchParams.set('session_id', data.session_id);
      window.location.href = u.toString();
    } catch (e) {
      setLoading(false);
      showError(e?.message || String(e));
    }
  });

  // ====== EMAIL/PASSWORD SUBMIT (UNCHANGED WORKING FLOW) ======
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    hideError();

    const alexaNow = getAlexaParamsFromQuery();
    if (!alexaNow) {
      showError('Invalid OAuth request. Please start linking from the Alexa app.');
      return;
    }

    const emailEl = document.getElementById('email');
    const passEl = document.getElementById('password');

    if (!emailEl.value || !passEl.value) return;

    setLoading(true, 'Authenticating…');

    try {
      const res = await fetch(EDGE_FUNCTION_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          email: emailEl.value,
          password: passEl.value,
          state: alexaNow.alexa_state,
          client_id: alexaNow.client_id,
          redirect_uri: alexaNow.redirect_uri
        })
      });

      const data = await res.json().catch(() => ({}));
      if (res.ok && data.redirect_url) {
        window.location.href = data.redirect_url;
      } else {
        throw new Error(data.error || 'Authentication failed');
      }
    } catch (err) {
      setLoading(false);
      showError(err?.message || 'Failed to connect to authentication server.');
    }
  });

  // ====== GUARD ======
  // Allow if:
  // - direct Alexa query params exist OR
  // - returning from Google with ?code=...
  const q = new URLSearchParams(window.location.search);
  if (!getAlexaParamsFromQuery() && !q.get('code')) {
    showError('Invalid OAuth request. Please start linking from the Alexa app.');
    submitBtn.disabled = true;
    googleBtn.disabled = true;
  }
</script>

</body>
</html>
